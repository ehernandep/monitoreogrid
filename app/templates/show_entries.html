{% extends "layout.html" %}
{% block body  %}
<div>

    <title>Dasboard</title>
    <div id="line_top_x"></div>
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('energy_monitor') }}">Panel de energía</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_vehicle_map') }}" aria-selected="false">Panel topográfico</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('show_entries') }}" aria-selected="true" >Gráficos personalizados</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_tables') }}" aria-selected="false">Tablas</a>
          </li>

        </ul>
     </div>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.18/c3.css" rel="stylesheet">

        <!-- Load d3.js and c3.js -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.18/c3.min.js"></script>
        <!-- <script type="text/javascript" src="http://d3js.org/d3.v5.min.js"></script> -->

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
          google.charts.load("current", {packages:["calendar"]});
          google.charts.setOnLoadCallback(drawChart);
          var data_cal = {{ calendar|safe }};
          console.log(data_cal)

            function drawChart() {
               var dataTable = new google.visualization.DataTable();
               dataTable.addColumn({ type: 'date', id: 'Date' });
               dataTable.addColumn({ type: 'number', id: 'Won/Loss' });
               for (var cal in data_cal) {
                       var cal_date = new Date(data_cal[cal]['date(timestamp)']);
                       cal_date.setDate(cal_date.getDate() + 1);
                       console.log(cal_date);
                       dataTable.addRows([[ cal_date, Math.round(data_cal[cal]['max_value']*100)/100 ]]);
                    }

               var chart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

               var options = {

               };
               var options = {
                    title: "Valores máximos por día",
                    allowHtml: true,
                    showRowNumber: true,
                    width: '100%',

              };

               chart.draw(dataTable, options);
               google.visualization.events.addListener(chart, 'select', selectHandler);

               function selectHandler() {

                    item = chart.getSelection()[0]
                    if (item.row != null) {

                        var date1 = new Date(data_cal[item.row]['date(timestamp)']);
                        date1.setDate(date1.getDate() + 1);
                        var dd = String(date1. getDate())
                        var mm = String(date1. getMonth() + 1). padStart(2, '0');
                        var yyyy = date1. getFullYear();
                        date1 = dd + '/' + mm + '/' + yyyy;
                        console.log(date1);
                        document.getElementById('d1_input').value = date1;
                        document.getElementById('d2_input').value = date1;
                        document.getElementById('Mainform').submit();
                    };
                };
           }
        </script>
        <script type="text/javascript">
          google.charts.load('current', {'packages':['table']});
          google.charts.setOnLoadCallback(drawTable);
          var data_vehicles = {{ vehicles|safe }};

          function drawTable() {
            var data = new google.visualization.DataTable();

            data.addColumn('number', 'Modelo');
            data.addColumn('string', 'Placa');
            data.addColumn('string', 'Marca');
            data.addColumn('number', 'Odometro');


            for (var row in data_vehicles) {
                data.addRows([[
                              data_vehicles[row]['year'],
                              data_vehicles[row]['placa'],
                              data_vehicles[row]['marca'],
                              data_vehicles[row]['odometer']
                ]]);
            }

            var table = new google.visualization.Table(document.getElementById('table_div'));
            var options = {
                allowHtml: true,
                showRowNumber: true,
                width: '100%',
                cssClassNames: {
                  tableCell: 'small-font'
                }
              };
            table.draw(data, options);

            //{showRowNumber: true, width: '100%', height: '2000%'}
              google.visualization.events.addListener(table, 'select', selectHandler);

                   function selectHandler() {
                       console.log('holalala')
                        item = table.getSelection()[0]
                        if (item.row != null) {
                            console.log(data_vehicles[item.row]);

                            req2 = $.ajax({
                                    url : "/update_vehicle/" + data_vehicles[item.row]['placa'],
                                    type : "GET",
                                });

                            req2.done(function(res) {

                                if (res == 1) {
                                    console.log('activo');
                                } else {
                                    console.log('no_activo');
                                    window.location.reload();
                                }
                            });

                        };
                    };
          }


        </script>
        <div id="table_div" style="width: 96%; margin: 20px;"></div>

        <div class="variables">
            <form role="form" class="form-inline" id="Mainform" action="{{ url_for('show_entries') }}" method=post>


                <div style="width: 100%;margin: 10px;">
                <select class="form-control" id="CalendarVarSelect" name = calendar_var onchange="this.form.submit();">
                    <option value="{{session.calendar_var}}"> {{session.calendar_var_pretty}}</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="mec_power">Potencia efectiva (server) (kW) </option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="elevation">Altitud (google api)</option>
                    <option value="elevation2">Altitud (Barómetro)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="speed">Velocidad instantánea (Km/h)</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                </select>
                </div>
                <div id="calendar_basic" style="width: 100%; margin: 20px;"></div>

                <div class="col-auto">
                    <label class="label label-default" for="exampleFormControlSelect1"> Eje X </label>
                    <select class="form-control" id="exampleFormControlSelect1" name = graph_var_x >
                        <option value="{{session.graph_var_x}}"> {{session.graph_var_x_pretty}}</option>
                        <option value="timestamp">Tiempo</option>
                        <option value="elevation">Altitud (google api)</option>
                        <option value="elevation2">Altitud (Barómetro)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="mean_speed">Velocidad promedio (Km/h)</option>
                        <option value="user_id">Usuario</option>
                        <option value="operative_state">Estado Operativo</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva (server) (kW) </option>
                        <option value="en_pot">Delta Energía potenical (J) </option>
                        <option value="net_signal">network quality </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                         <option value="angle_x">Angulo X </option>
                        <option value="angle_y">Angulo Y </option>
                        <option value="AcX">Acelerómetro (X) </option>
                        <option value="AcY">Acelerómetro (Y) </option>
                        <option value="AcZ">Acelerómetro (Z) </option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="charge_time">Tiempo de carga </option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="tpms">presion llantas (psi)</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                        <option value="assist_level">Nivel de asistencia</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label class="label label-default" for="exampleFormControlSelect2"> Eje Y </label>
                    <select class="form-control" id="exampleFormControlSelect2" name = graph_var_y onchange="this.form.submit();">
                        <option value="{{session.graph_var_y}}"> {{session.graph_var_y_pretty}}</option>
                        <option value="elevation">Altitud (google api)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="speed">Velocidad instantánea (Km/h)</option>
                        <option value="user_id">Usuario</option>
                        <option value="operative_state">Estado Operativo</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva (Kw) </option>
                        <option value="eff">Eficiencia (%) </option>
                        <option value="angle_x">Angulo X </option>
                        <option value="angle_y">Angulo Y </option>

                        <option value="energy">Energía acomulada (kWh) </option>
                        <option value="energy_rec">Energia recuperada (kWh) </option>

                        <option value="AcX">Acelerómetro (X) </option>
                        <option value="AcY">Acelerómetro (Y) </option>
                        <option value="AcZ">Acelerómetro (Z) </option>
                        <option value="humidity">Humedad (%) </option>
                        <option value="q_loss">Perdida de Capacidad </option>
                        <option value="net_force">Fuerza neta (N) </option>

                        <option value="run">Recorrido desde ultimo registro (m) </option>
                        <option value="net_signal">network quality </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="energy_rec">Energia recuperada (Kwh) </option>
                        <option value="charge_current">Corriente de carga (A) </option>
                        <option value="charge_time">Tiempo de Carga (s) </option>
                        <option value="charger_type">Tipo de cargador  </option>
                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                        <option value="assist_level">Nivel de asistencia</option>
                    </select>
                </div>

                <div class='col-sm-2'>
                    <label class="label label-default" for="date"> Fecha </label>
                    <div class="form-group" id = 'date'>
                        <div class='input-group date' id='datetimepicker1'>
                            <input type='text' id = 'd1_input' class="form-control" name = 'd1' />
                            <span class="input-group-addon"><span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script type="text/javascript">
                    document.getElementById('d1_input').defaultValue = '{{ session.form_d1 }}'
                    $(function() {
                       $('#datetimepicker1').datetimepicker({
                             format: 'DD/MM/YYYY'
                       });
                    });
                </script>

                <div class='col-sm-2'>
                    <label class="label label-default" for="hora1"> Desde </label>
                    <div class="form-group" id="hora1">
                        <div class='input-group date' id='datetimepicker3'>
                            <input type='text' id = 'h1_input' class="form-control" name = 'h1'/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script type="text/javascript">

                    document.getElementById('h1_input').defaultValue = '{{ session.form_h1 }}'
                    $(function () {
                        $('#datetimepicker3').datetimepicker({
                            format: 'LT'
                        });
                    });
                </script>

                <div class='col-sm-2'>
                    <label class="label label-default" for="hora2"> Hasta </label>
                    <div class="form-group" id="hora2">
                        <div class='input-group date' id='datetimepicker4'>
                            <input type='text' id = 'h2_input' class="form-control" name = 'h2'/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script>
                    document.getElementById('h2_input').defaultValue = '{{ session.form_h2 }}';
                    $(function () {
                        $('#datetimepicker4').datetimepicker({
                            format: 'LT'
                        });
                    });
                </script>
                <div class="col-auto">
                    <button class="btn btn-dark" type="submit">Ver</button>
                </div>

                <div style="width: 100%">
                    <div id = "bargraph" style="width:70%;float: left">
                        <script>
                            var graphs = {{plot | safe}};

                            smoothTrace1 = {
                               'type': 'scatter',
                               'mode': 'line+markers',
                               'x': graphs[0]['x'],
                               'y': graphs[0]['y'],
                               //fill: 'tozeroy',
                               //'line': {'shape': 'spline', 'smoothing': 0.45}
                           }


                            data1=[smoothTrace1]
                            Plotly.newPlot('bargraph',data1, {});
                        </script>
                    </div>

                    <div id = 'boxDiv2' style="width:30%;float: right;">
                        <script>
                            var name1 = "{{session.graph_var_y_pretty}}";
                            var y0 = {{box | safe}};
                            var trace1 = {
                              y: y0,
                              type: 'box',
                              color: 'blue',
                              name: "{{session.graph_var_y_pretty}}",
                              boxmean: 'sd'
                            };

                            var data = [trace1];
                            Plotly.newPlot('boxDiv2', data);
                        </script>
                    </div>
                </div>
                <div class="col-auto" >
                    <label class="label label-default" for="FormControlSelect1"> Eje X </label>
                    <select class="form-control" id="FormControlSelect1" name = graph_var_x2>
                        <option value="{{session.graph_var_x2}}"> {{session.graph_var_x2_pretty}}</option>
                       <option value="timestamp">Tiempo</option>
                        <option value="elevation">Altitud (google api)</option>
                        <option value="elevation2">Altitud (Barómetro)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="mean_speed">Velocidad promedio (Km/h)</option>
                        <option value="user_id">Usuario</option>
                        <option value="operative_state">Estado Operativo</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva (server) (kW) </option>
                        <option value="en_pot">Delta Energía potenical (J) </option>
                        <option value="net_signal">network quality </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                         <option value="angle_x">Angulo X </option>
                        <option value="angle_y">Angulo Y </option>
                        <option value="AcX">Acelerómetro (X) </option>
                        <option value="AcY">Acelerómetro (Y) </option>
                        <option value="AcZ">Acelerómetro (Z) </option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="charge_time">Tiempo de carga </option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="tpms">presion llantas (psi)</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                        <option value="assist_level">Nivel de asistencia</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label class="label label-default" for="FormControlSelect2"> Eje Y </label>
                    <select class="form-control" id="FormControlSelect2" name = graph_var_y2 onchange="this.form.submit();">
                        <option value="{{session.graph_var_y2}}"> {{session.graph_var_y2_pretty}}</option>
                        <option value="elevation">Altitud (google api)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="speed">Velocidad instantánea (Km/h)</option>
                        <option value="user_id">Usuario</option>
                        <option value="operative_state">Estado Operativo</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva (Kw) </option>
                        <option value="eff">Eficiencia (%) </option>
                        <option value="angle_x">Angulo X </option>
                        <option value="angle_y">Angulo Y </option>

                        <option value="energy">Energía acomulada (kWh) </option>
                        <option value="energy_rec">Energia recuperada (kWh) </option>

                        <option value="AcX">Acelerómetro (X) </option>
                        <option value="AcY">Acelerómetro (Y) </option>
                        <option value="AcZ">Acelerómetro (Z) </option>
                        <option value="humidity">Humedad (%) </option>
                        <option value="q_loss">Perdida de Capacidad </option>
                        <option value="net_force">Fuerza neta (N) </option>

                        <option value="run">Recorrido desde ultimo registro (m) </option>
                        <option value="net_signal">network quality </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="energy_rec">Energia recuperada (Kwh) </option>
                        <option value="charge_current">Corriente de carga (A) </option>
                        <option value="charge_time">Tiempo de Carga (s) </option>
                        <option value="charger_type">Tipo de cargador  </option>
                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                        <option value="assist_level">Nivel de asistencia</option>
                    </select>
                </div>

                <div class='col-sm-2'>
                    <label class="label label-default" for="date"> Fecha </label>
                    <div class="form-group" id = 'date2'>
                        <div class='input-group date' id='datetimepicker5'>
                            <input type='text' id = 'd2_input' class="form-control" name = 'd2' />
                            <span class="input-group-addon"><span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script type="text/javascript">
                    document.getElementById('d2_input').defaultValue = '{{ session.form_d2 }}'
                    $(function() {
                       $('#datetimepicker5').datetimepicker({
                             format: 'DD/MM/YYYY'
                       });
                    });
                </script>
                <div class='col-sm-2'>
                    <label class="label label-default" for="hora3"> Desde </label>
                    <div class="form-group" id="hora3">
                        <div class='input-group date' id='datetimepicker6'>
                            <input type='text' id = 'h3_input' class="form-control" name = 'h3'/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script type="text/javascript">
                    document.getElementById('h3_input').defaultValue = '{{ session.form_h3 }}'
                    $(function () {
                        $('#datetimepicker6').datetimepicker({
                            format: 'LT'
                        });
                    });
                </script>
                <div class='col-sm-2'>
                    <label class="label label-default" for="hora4"> Hasta </label>
                    <div class="form-group" id="hora4">
                        <div class='input-group date' id='datetimepicker7'>
                            <input type='text' id = 'h4_input' class="form-control" name = 'h4'/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script>
                    document.getElementById('h4_input').defaultValue = '{{ session.form_h4 }}';
                    $(function () {
                        $('#datetimepicker7').datetimepicker({
                            format: 'LT'
                        });
                    });
                </script>
            </form>
        </div>
        <div>
            <div style="width:100%;height:450px">
                <div class="chart" id="bargraph2" style="width:70%;float: left">
                    <script>
                        var graphs2 = {{plot2 | safe}};

                        var trace1 = {
                          x: graphs2[0]['x'],
                          y: graphs2[0]['y'],
                          fill: 'tozeroy',
                          type: 'scatter',
                          shape: "spline"
                        };

                        smoothTrace = {
                           'type': 'scatter',
                           'mode': 'lines',
                           'x': graphs2[0]['x'],
                           'y': graphs2[0]['y'],
                           fill: 'tozeroy',
                           'line': {
                                'shape': 'spline',
                                'smoothing': 0.15}
                          }

                        data=[smoothTrace]
                        Plotly.newPlot('bargraph2',data, {});
                    </script>
                </div>
                <div class="chart" id = 'boxDiv' style="width:30%;float: right" >
                    <script>
                        var y2 = {{box2 | safe}};
                        var trace2 = {
                          y: y2,
                          type: 'box',
                          color: 'orange',
                          name: "{{session.graph_var_y2_pretty}}"+" (Fig 2)",
                          boxmean: 'sd'
                        };

                        var data = [trace2];
                        Plotly.newPlot('boxDiv', data);
                    </script>
                </div>
            </div>
            <div class="chart" id = 'histDiv' style="width:100%;">
                <script>
                    var y0 = {{box | safe}};
                    var trace1 = {
                      y: y0,
                      type: 'violin',
                      box: {
                        visible: true
                      },
                      line: {
                        color: 'black'
                      },
                      fillcolor: 'blue',
                      opacity: 0.6,
                      meanline: {
                        visible: true
                      },
                      name: "{{session.graph_var_y_pretty}}"+" (Fig 1)",
                      boxmean: 'sd'
                    };


                    var y1 = {{box2 | safe}};
                    var trace2 = {
                      y: y1,
                      type: 'violin',
                      box: {
                        visible: true
                      },
                      line: {
                        color: 'black'
                      },
                      fillcolor: 'orange',
                      opacity: 0.6,
                      meanline: {
                        visible: true
                      },
                      name: "{{session.graph_var_y2_pretty}}"+" (Fig 2)",
                      boxmean: 'sd'
                    };

                    var data = [trace1, trace2];
                    var layout = {
                      title: "",
                      yaxis: {
                        zeroline: false
                      }
                    }
                    Plotly.newPlot('histDiv', data, layout);
                </script>
            </div>

        </div>



    <script>
        $(document).ready(function(){
            function loadlink(){

                req = $.ajax({
                    url : "/updateplot",
                    type : "GET",
                });

                req.done(function(res) {
                    $("#bargraph").fadeOut(100).fadeIn(100);
                    var graphs_react = JSON.parse(res);

                    var trace_react = {
                          x: graphs_react[0]['x'],
                          y: graphs_react[0]['y'],
                          type: 'scatter',
                          'mode': 'line+markers',
                        };

                        data_react=[trace_react]

                    Plotly.react('bargraph', data_react, {});
                });
            };
            setInterval(function(){
                loadlink() // this will run after every 60 seconds
            }, 6000);
        });
    </script>
</div>
{% endblock %}
