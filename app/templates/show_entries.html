{% extends "layout.html" %}
{% block body  %}
<head>
    <title>Dasboard</title>
        <!-- plotly graph. -->
        <h2>
            {{ current_user.username }}
        </h2>

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>


        <div class="variables">
            <form role="form" class="form-inline" action="{{ url_for('graph_var') }}" method=post>
                <div class="col-auto">
                    <label class="label label-default" for="exampleFormControlSelect1"> Eje X </label>
                    <select class="form-control" id="exampleFormControlSelect1" name = variable_x>
                        <option value="{{session.graph_var_x}}"> {{session.x_pretty_graph}}</option>
                        <option value="timestamp">Tiempo</option>
                        <option value="elevation">Altitud (msnm)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="speed">Velocidad (Km/h)</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (Ah)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva promedio (Kw)</option>
                        <option value="mec_power_delta_e">Potencia efectiva Máxima (Kw) </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                        <option value="acceleration">Aceleración motor </option>
                        <option value="throttle">Pedal de acelerador</option>
                        <option value="regen_brake">Freno regenerativo</option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="charge_time">Tiempo de carga </option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="tpms">presion llantas (psi)</option>
                        <option value="ocv">OCV</option>
                        <option value="occupants">Ocupantes</option>
                        <option value="footbrake">Freno de pedal</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                    </select>
                </div>
            <div class="col-auto">
                <label class="label label-default" for="exampleFormControlSelect2"> Eje Y </label>
                <select class="form-control" id="exampleFormControlSelect2" name = variable_y>
                    <option value="{{session.graph_var_y}}"> {{session.y_pretty_graph}}</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="speed">Velocidad (Km/h)</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (Ah)</option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="mec_power">Potencia efectiva promedio (Kw)</option>
                    <option value="mec_power_delta_e">Potencia efectiva Máxima (Kw) </option>
                    <option value="soc">SOC</option>
                    <option value="soh">SOH</option>
                    <option value="batt_temp">Temperatura de batería (°C)</option>
                    <option value="ext_temp">Temperatura externa (°C)</option>
                    <option value="voltage">Voltage (V)</option>
                    <option value="current">Corriente (A)</option>
                    <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                    <option value="acceleration">Aceleración motor </option>
                    <option value="throttle">Pedal de acelerador</option>
                    <option value="regen_brake">Freno regenerativo</option>
                    <option value="consumption">Consumo</option>
                    <option value="range_est">Rango estimado</option>
                    <option value="range_ideal">Rango ideal</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="charge_time">Tiempo de carga </option>
                    <option value="is_charging">Esta cargando</option>
                    <option value="tpms">presion llantas (psi)</option>
                    <option value="ocv">OCV</option>
                    <option value="occupants">Ocupantes</option>
                    <option value="footbrake">Freno de pedal</option>
                    <option value="engine_temp">Temperatura de motor (°C)</option>
                </select>
            </div>

            <div class='col-sm-2'>
                <label class="label label-default" for="date"> Fecha </label>
                <div class="form-group" id = 'date'>
                    <div class='input-group date' id='datetimepicker1'>
                        <input type='text' id = 'd1_input' class="form-control" name = 'd1' />
                        <span class="input-group-addon"><span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                document.getElementById('d1_input').defaultValue = '{{ session.form_d1 }}'
                $(function() {
                   $('#datetimepicker1').datetimepicker({
                         format: 'DD/MM/YYYY'
                   });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora1"> Desde </label>
                <div class="form-group" id="hora1">
                    <div class='input-group date' id='datetimepicker3'>
                        <input type='text' id = 'h1_input' class="form-control" name = 'h1'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">

                document.getElementById('h1_input').defaultValue = '{{ session.form_h1 }}'
                $(function () {
                    $('#datetimepicker3').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora2"> Hasta </label>
                <div class="form-group" id="hora2">
                    <div class='input-group date' id='datetimepicker4'>
                        <input type='text' id = 'h2_input' class="form-control" name = 'h2'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script>
                document.getElementById('h2_input').defaultValue = '{{ session.form_h2 }}';
                $(function () {
                    $('#datetimepicker4').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>
            <div class="col-auto">
                <button class="btn btn-dark" type="submit">Ver</button>
            </div>

            </form>
        </div>


        <div class="container" id = "grafica">
            <div class="chart" id="bargraph" >
                <script>
                    var graphs = {{plot | safe}};
                    Plotly.plot('bargraph',graphs,{});
                </script>
            </div>
            <div class="chart" id="donn_graph" style="width:40%;height:400px;float:left">
                <script>
                    var graphs2 = {{pie | safe}};
                    Plotly.plot('donn_graph',graphs2,{});
                </script>
            </div>


            <div class="chart" id = 'myDiv' style="width:40%;height:250px;float:right"></div>
            <script>
                //TESTER = document.getElementById('myDiv');
                Plotly.d3.csv('https://raw.githubusercontent.com/plotly/datasets/master/api_docs/mt_bruno_elevation.csv', function(err, rows){
                function unpack(rows, key) {
                  return rows.map(function(row) { return row[key]; });
                }
                var z_data=[ ]
                for(i=0;i<24;i++)
                {
                  z_data.push(unpack(rows,i));
                }

                var data = [{
                  z: z_data,
                  type: 'surface',
                  contours: {
                    z: {
                      show:true,
                      usecolormap: true,
                      highlightcolor:"#42f462",
                      project:{z: true}
                    }
                  }
                }];

                var layout = {
                  title: 'Mt Bruno Elevation With Projected Contours',
                  scene: {camera: {eye: {x: 1.87, y: 0.88, z: -0.64}}},
                  autosize: false,
                  width: 500,
                  height: 500,
                  margin: {
                    l: 65,
                    r: 50,
                    b: 65,
                    t: 90,
                  }
                };

                Plotly.newPlot('myDiv', data, layout);
                });
            </script>
        </div>

    <script>
    $(document).ready(function(){
        function loadlink(){

            req = $.ajax({
                url : "/updateplot",
                type : "GET",

            });

            req.done(function(res) {
                $("#bargraph").fadeOut(100).fadeIn(100);
                var graphs = JSON.parse(res);
                console.log(graphs)
                Plotly.react('bargraph', graphs, {});
            });
        };
        setInterval(function(){
            loadlink() // this will run after every 30 seconds
        }, 30000);
    });


    </script>

{% endblock %}
