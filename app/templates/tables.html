{% extends "layout.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block body %}

    <title>Tablas </title>
    <div id="line_top_x"></div>
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('energy_monitor') }}">Panel de energía</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_vehicle_map') }}" aria-selected="false">Panel topográfico</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_entries') }}" aria-selected="false" >Gráficos personalizados</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('show_tables') }}" aria-selected="true">Tablas</a>
          </li>

        </ul>
     </div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load("current", {packages:["calendar"]});
      google.charts.setOnLoadCallback(drawChart);
      var data_cal = {{ calendar|safe }};

        function drawChart() {
           var dataTable = new google.visualization.DataTable();
           dataTable.addColumn({ type: 'date', id: 'Date' });
           dataTable.addColumn({ type: 'number', id: 'Won/Loss' });
           for (var cal in data_cal) {
                   var cal_date = new Date(data_cal[cal]['date(timestamp)']);
                   cal_date.setDate(cal_date.getDate() + 1);
                   console.log(cal_date);
                   dataTable.addRows([[ cal_date, Math.round(data_cal[cal]['max_value']*100)/100 ]]);
                }

           var chart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

           var options = {
             title: "Valores máximos por día",
             height: 175,
           };

           chart.draw(dataTable, options);
           google.visualization.events.addListener(chart, 'select', selectHandler);

           function selectHandler() {

                item = chart.getSelection()[0]
                if (item.row != null) {

                    var date1 = new Date(data_cal[item.row]['date(timestamp)']);
                    date1.setDate(date1.getDate() + 1);
                    var dd = String(date1. getDate())
                    var mm = String(date1. getMonth() + 1). padStart(2, '0');
                    var yyyy = date1. getFullYear();
                    date1 = dd + '/' + mm + '/' + yyyy;
                    console.log(date1);
                    document.getElementById('d1_input').value = date1;
                    document.getElementById('Mainform').submit();
                };
            };
       }
    </script>

    Hint: select slope, mean_speed, mean_acc, power_kw for consumption models evaluation
    <div class="variables">
            <form role="form" class="form-inline" id="Mainform" action="{{ url_for('show_tables') }}" method=post>
                <div style="width: 100%;margin: 10px;">
                    <select class="form-control" id="CalendarVarSelect" name = calendar_var onchange="this.form.submit();">
                        <option value="{{session.calendar_var}}"> {{session.calendar_pretty}}</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="mec_power">Potencia efectiva (server) (kW) </option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="elevation">Altitud (google api)</option>
                        <option value="elevation2">Altitud (Barómetro)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="mean_speed">Velocidad promedio (Km/h)</option>
                        <option value="speed">Velocidad instantánea (Km/h)</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                    </select>
                </div>
                <div id="calendar_basic" style="width: 100%; height: 175px;margin: 20px;"></div>
                <div class="col-auto">
                    <label class="label label-default" for="exampleFormControlSelect1"> Variable 1 </label>
                    <select class="form-control" id="exampleFormControlSelect1" name = var1>
                        <option value="{{session.var1}}"> {{session.var1_pretty}}</option>
                        <option value="elevation">Altitud (msnm)</option>
                        <option value="slope">Pendiente (°)</option>
                        <option value="mean_speed">Velocidad promedio (Km/h)</option>
                        <option value="odometer">Odometro (Km)</option>
                        <option value="capacity">Capacidad (kWh)</option>
                        <option value="power_kw">Potencia eléctrica (Kw)</option>
                        <option value="mec_power">Potencia efectiva (Kw) </option>
                        <option value="eff">Eficiencia (%) </option>
                        <option value="en_pot">Delta Energía potenical (J) </option>
                        <option value="net_force">Fuerza neta (N) </option>
                        <option value="friction_force">Fuerza de fricción (N) </option>
                        <option value="freeram">free ram </option>
                        <option value="tasks">tasks number </option>
                        <option value="net_signal">network quality </option>
                        <option value="run">Recorrido desde ultimo registro (m) </option>
                        <option value="soc">SOC</option>
                        <option value="soh">SOH</option>
                        <option value="angle_x">Angulo X </option>
                        <option value="angle_y">Angulo Y </option>
                        <option value="q_loss">Perdida de Capacidad </option>

                        <option value="energy_rec">Energia recuperada (Kwh) </option>
                        <option value="charge_current">Corriente de carga (A) </option>
                        <option value="charge_time">Tiempo de Carga (s) </option>
                        <option value="charger_type">Tipo de cargador  </option>

                        <option value="batt_temp">Temperatura de batería (°C)</option>
                        <option value="ext_temp">Temperatura externa (°C)</option>
                        <option value="voltage">Voltage (V)</option>
                        <option value="current">Corriente (A)</option>
                        <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                        <option value="acceleration">Aceleración motor </option>
                        <option value="throttle">Pedal de acelerador</option>
                        <option value="regen_brake">Freno regenerativo</option>
                        <option value="consumption">Consumo</option>
                        <option value="range_est">Rango estimado</option>
                        <option value="range_ideal">Rango ideal</option>
                        <option value="drivetime">Tiempo de manejo</option>
                        <option value="charge_time">Tiempo de carga </option>
                        <option value="is_charging">Esta cargando</option>
                        <option value="tpms">presion llantas (psi)</option>
                        <option value="ocv">OCV</option>
                        <option value="occupants">Ocupantes</option>
                        <option value="footbrake">Freno de pedal</option>
                        <option value="engine_temp">Temperatura de motor (°C)</option>
                    </select>
                </div>
            <div class="col-auto">
                <label class="label label-default" for="exampleFormControlSelect2"> Variable 2 </label>
                <select class="form-control" id="exampleFormControlSelect2" name = var2>
                    <option value="{{session.var2}}"> {{session.var2_pretty}}</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="user_id">Usuario</option>
                    <option value="operative_state">Estado Operativo</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="mec_power">Potencia efectiva (Kw) </option>
                    <option value="eff">Eficiencia (%) </option>
                    <option value="en_pot">Delta Energía potenical (J) </option>
                    <option value="net_force">Fuerza neta (N) </option>
                    <option value="freeram">free ram </option>
                    <option value="tasks">tasks number </option>
                    <option value="net_signal">network quality </option>
                    <option value="friction_force">Fuerza de fricción (N) </option>
                    <option value="run">Recorrido desde ultimo registro (m) </option>
                    <option value="soc">SOC</option>
                    <option value="soh">SOH</option>
                    <option value="angle_x">Angulo X </option>
                    <option value="angle_y">Angulo Y </option>
                    <option value="q_loss">Perdida de Capacidad </option>

                    <option value="energy_rec">Energia recuperada (Kwh) </option>
                    <option value="charge_current">Corriente de carga (A) </option>
                    <option value="charge_time">Tiempo de Carga (s) </option>
                    <option value="charger_type">Tipo de cargador  </option>

                    <option value="batt_temp">Temperatura de batería (°C)</option>
                    <option value="ext_temp">Temperatura externa (°C)</option>
                    <option value="voltage">Voltage (V)</option>
                    <option value="current">Corriente (A)</option>
                    <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                    <option value="acceleration">Aceleración motor </option>
                    <option value="throttle">Pedal de acelerador</option>
                    <option value="regen_brake">Freno regenerativo</option>
                    <option value="consumption">Consumo</option>
                    <option value="range_est">Rango estimado</option>
                    <option value="range_ideal">Rango ideal</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="charge_time">Tiempo de carga </option>
                    <option value="is_charging">Esta cargando</option>
                    <option value="tpms">presion llantas (psi)</option>
                    <option value="ocv">OCV</option>
                    <option value="occupants">Ocupantes</option>
                    <option value="footbrake">Freno de pedal</option>
                    <option value="engine_temp">Temperatura de motor (°C)</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="label label-default" for="exampleFormControlSelect3"> Variable 3 </label>
                <select class="form-control" id="exampleFormControlSelect3" name = var3>
                    <option value="{{session.var3}}"> {{session.var3_pretty}}</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="user_id">Usuario</option>
                    <option value="operative_state">Estado Operativo</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="mec_power">Potencia efectiva (Kw) </option>
                    <option value="eff">Eficiencia (%) </option>
                    <option value="en_pot">Delta Energía potenical (J) </option>
                    <option value="net_force">Fuerza neta (N) </option>
                    <option value="friction_force">Fuerza de fricción (N) </option>
                    <option value="freeram">free ram </option>
                    <option value="tasks">tasks number </option>
                    <option value="net_signal">network quality </option>
                    <option value="run">Recorrido desde ultimo registro (m) </option>
                    <option value="soc">SOC</option>
                    <option value="soh">SOH</option>
                    <option value="angle_x">Angulo X </option>
                    <option value="angle_y">Angulo Y </option>
                    <option value="q_loss">Perdida de Capacidad </option>

                    <option value="energy_rec">Energia recuperada (Kwh) </option>
                    <option value="charge_current">Corriente de carga (A) </option>
                    <option value="charge_time">Tiempo de Carga (s) </option>
                    <option value="charger_type">Tipo de cargador  </option>

                    <option value="batt_temp">Temperatura de batería (°C)</option>
                    <option value="ext_temp">Temperatura externa (°C)</option>
                    <option value="voltage">Voltage (V)</option>
                    <option value="current">Corriente (A)</option>
                    <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                    <option value="acceleration">Aceleración motor </option>
                    <option value="throttle">Pedal de acelerador</option>
                    <option value="regen_brake">Freno regenerativo</option>
                    <option value="consumption">Consumo</option>
                    <option value="range_est">Rango estimado</option>
                    <option value="range_ideal">Rango ideal</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="charge_time">Tiempo de carga </option>
                    <option value="is_charging">Esta cargando</option>
                    <option value="tpms">presion llantas (psi)</option>
                    <option value="ocv">OCV</option>
                    <option value="occupants">Ocupantes</option>
                    <option value="footbrake">Freno de pedal</option>
                    <option value="engine_temp">Temperatura de motor (°C)</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="label label-default" for="exampleFormControlSelect4"> Variable 4 </label>
                <select class="form-control" id="exampleFormControlSelect4" name = var4>
                    <option value="{{session.var4}}"> {{session.var4_pretty}}</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="user_id">Usuario</option>
                    <option value="operative_state">Estado Operativo</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="mec_power">Potencia efectiva (Kw) </option>
                    <option value="eff">Eficiencia (%) </option>
                    <option value="en_pot">Delta Energía potenical (J) </option>
                    <option value="net_force">Fuerza neta (N) </option>
                    <option value="freeram">free ram </option>
                    <option value="tasks">tasks number </option>
                    <option value="net_signal">network quality </option>
                    <option value="friction_force">Fuerza de fricción (N) </option>
                    <option value="run">Recorrido desde ultimo registro (m) </option>
                    <option value="soc">SOC</option>
                    <option value="soh">SOH</option>
                    <option value="angle_x">Angulo X </option>
                    <option value="angle_y">Angulo Y </option>
                    <option value="q_loss">Perdida de Capacidad </option>

                    <option value="energy_rec">Energia recuperada (Kwh) </option>
                    <option value="charge_current">Corriente de carga (A) </option>
                    <option value="charge_time">Tiempo de Carga (s) </option>
                    <option value="charger_type">Tipo de cargador  </option>

                    <option value="batt_temp">Temperatura de batería (°C)</option>
                    <option value="ext_temp">Temperatura externa (°C)</option>
                    <option value="voltage">Voltage (V)</option>
                    <option value="current">Corriente (A)</option>
                    <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                    <option value="acceleration">Aceleración motor </option>
                    <option value="throttle">Pedal de acelerador</option>
                    <option value="regen_brake">Freno regenerativo</option>
                    <option value="consumption">Consumo</option>
                    <option value="range_est">Rango estimado</option>
                    <option value="range_ideal">Rango ideal</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="charge_time">Tiempo de carga </option>
                    <option value="is_charging">Esta cargando</option>
                    <option value="tpms">presion llantas (psi)</option>
                    <option value="ocv">OCV</option>
                    <option value="occupants">Ocupantes</option>
                    <option value="footbrake">Freno de pedal</option>
                    <option value="engine_temp">Temperatura de motor (°C)</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="label label-default" for="exampleFormControlSelect5"> Variable 5 </label>
                <select class="form-control" id="exampleFormControlSelect5" name = var5>
                    <option value="{{session.var5}}"> {{session.var5_pretty}}</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="user_id">Usuario</option>
                    <option value="operative_state">Estado Operativo</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="mec_power">Potencia efectiva (Kw) </option>
                    <option value="eff">Eficiencia (%) </option>
                    <option value="en_pot">Delta Energía potenical (J) </option>
                    <option value="net_force">Fuerza neta (N) </option>
                    <option value="freeram">free ram </option>
                    <option value="tasks">tasks number </option>
                    <option value="net_signal">network quality </option>
                    <option value="friction_force">Fuerza de fricción (N) </option>
                    <option value="run">Recorrido desde ultimo registro (m) </option>
                    <option value="soc">SOC</option>
                    <option value="soh">SOH</option>
                    <option value="angle_x">Angulo X </option>
                    <option value="angle_y">Angulo Y </option>
                    <option value="q_loss">Perdida de Capacidad </option>

                    <option value="energy_rec">Energia recuperada (Kwh) </option>
                    <option value="charge_current">Corriente de carga (A) </option>
                    <option value="charge_time">Tiempo de Carga (s) </option>
                    <option value="charger_type">Tipo de cargador  </option>

                    <option value="batt_temp">Temperatura de batería (°C)</option>
                    <option value="ext_temp">Temperatura externa (°C)</option>
                    <option value="voltage">Voltage (V)</option>
                    <option value="current">Corriente (A)</option>
                    <option value="mean_acc">Aceleración promedio (m/s^2)</option>
                    <option value="acceleration">Aceleración motor </option>
                    <option value="throttle">Pedal de acelerador</option>
                    <option value="regen_brake">Freno regenerativo</option>
                    <option value="consumption">Consumo</option>
                    <option value="range_est">Rango estimado</option>
                    <option value="range_ideal">Rango ideal</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="charge_time">Tiempo de carga </option>
                    <option value="is_charging">Esta cargando</option>
                    <option value="tpms">presion llantas (psi)</option>
                    <option value="ocv">OCV</option>
                    <option value="occupants">Ocupantes</option>
                    <option value="footbrake">Freno de pedal</option>
                    <option value="engine_temp">Temperatura de motor (°C)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="label label-default" for="records_input">Número de registros</label>
                <input type="number" class="form-control" id="records_input" name="records"  placeholder="# registros">
            </div>
            <script>
                document.getElementById('records_input').defaultValue = '{{ session.records }}';
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="date"> Fecha </label>
                <div class="form-group" id = 'date'>
                    <div class='input-group date' id='datetimepicker1'>
                        <input type='text' id = 'd1_input' class="form-control" name = 'd1' />
                        <span class="input-group-addon"><span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                document.getElementById('d1_input').defaultValue = '{{ session.form_d1 }}'
                $(function() {
                   $('#datetimepicker1').datetimepicker({
                         format: 'DD/MM/YYYY'
                   });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora1"> Desde </label>
                <div class="form-group" id="hora1">
                    <div class='input-group date' id='datetimepicker3'>
                        <input type='text' id = 'h1_input' class="form-control" name = 'h1'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">

                document.getElementById('h1_input').defaultValue = '{{ session.form_h1 }}'
                $(function () {
                    $('#datetimepicker3').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora2"> Hasta </label>
                <div class="form-group" id="hora2">
                    <div class='input-group date' id='datetimepicker4'>
                        <input type='text' id = 'h2_input' class="form-control" name = 'h2'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script>
                document.getElementById('h2_input').defaultValue = '{{ session.form_h2 }}';
                $(function () {
                    $('#datetimepicker4').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>
            <div class="col-auto">
                <button class="btn btn-dark" type="submit">Ver</button>
            </div>

            </form>
        </div>

 <div style="width: 100%">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <div id = "bargraph" style="width:50%;float: left">
        <script>
            var graphs = {{plot | safe}};

            scatter_trace = {
               'type': 'scatter',
               'mode': 'markers',
               'name': 'Jimenez vs potencia e',
               'x': graphs[0]['x'],
               'y': graphs[0]['y'],
               //fill: 'tozeroy',
               //'line': {'shape': 'spline', 'smoothing': 0.45}
           }


            data1=[scatter_trace]
            Plotly.newPlot('bargraph',data1, {});
        </script>
    </div>
    <div id = "bargraph2" style="width:50%;float: right">
        <script>
            var integral_j = {{plotint1 | safe}};
            var integral_p = {{plotint2 | safe}};
            var integral_f = {{plotint3 | safe}};

            smoothTrace1 = {
               'type': 'scatter',
               'name': 'Consumo estimado (Jimenez)(kWh)',
               'mode': 'lines',
               'x': integral_j[0]['x'],
               'y': integral_j[0]['y'],
               fill: 'tozeroy',
               'line': {'shape': 'spline', 'smoothing': 0.2}
           }

           smoothTrace2 = {
               'type': 'scatter',
               'name': 'Consumo real (kWh)',
               'mode': 'lines',
               'x': integral_p[0]['x'],
               'y': integral_p[0]['y'],
               fill: 'tozeroy',
               'line': {'shape': 'spline', 'smoothing': 0.2}
           }

           smoothTrace3 = {
               'type': 'scatter',
               'name': 'Consumo estimado (Fiori)(kWh)',
               'mode': 'lines',
               'x': integral_f[0]['x'],
               'y': integral_f[0]['y'],
               fill: 'tozeroy',
               'line': {'shape': 'spline', 'smoothing': 0.2}
           }


            data_integrals = [smoothTrace1, smoothTrace2, smoothTrace3]
            Plotly.newPlot('bargraph2', data_integrals, {});
        </script>
    </div>
</div>


    <table class="table">

    <tbody>
        {% for table in tables %}
        <tr>
            <td>{{ table|safe }}</td>
        </tr>
        {% endfor %}
    </tbody>
            {{ table|safe }}
</table>

{% endblock %}


