{% extends "layout.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block body %}

<head>
    <title>Barrios</title>
    <div id="line_top_x"></div>
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('energy_monitor') }}">Panel de energía</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('show_vehicle_map') }}" aria-selected="true">Panel topográfico</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_entries') }}" aria-selected="false" >Gráficos personalizados</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('show_tables') }}" aria-selected="false">Tablas</a>
          </li>

        </ul>
     </div>
    <ul class="nav nav-tabs">
          <li class="nav-item">
          <a class="nav-link" id="v-pills-profile-tab"  href="{{ url_for('show_vehicle_map') }}" >Vehículos</a>
          </li>
         <li class="nav-item">
          <a class="nav-link active" href="{{ url_for('show_zones_map') }}" >Zonas</a>
         </li>
    </ul>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load("current", {packages:["calendar"]});
      google.charts.setOnLoadCallback(drawChart);
      var data_cal = {{ calendar|safe }};

        function drawChart() {
           var dataTable = new google.visualization.DataTable();
           dataTable.addColumn({ type: 'date', id: 'Date' });
           dataTable.addColumn({ type: 'number', id: 'Max_value' });
           for (var cal in data_cal) {
                   var cal_date = new Date(data_cal[cal]['date(timestamp)']);
                   cal_date.setDate(cal_date.getDate() + 1);
                   console.log(cal_date);
                   dataTable.addRows([[ cal_date, Math.round(data_cal[cal]['max_value']*100)/100 ]]);
                }

           var chart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

           var options = {
             title: "Valores máximos por día",
           };

           chart.draw(dataTable, options);
           google.visualization.events.addListener(chart, 'select', selectHandler);

           function selectHandler() {
                item = chart.getSelection()[0]
                if (item.row != null) {

                    var date1 = new Date(data_cal[item.row]['date(timestamp)']);
                    date1.setDate(date1.getDate() + 1);
                    var dd = String(date1. getDate())
                    var mm = String(date1. getMonth() + 1). padStart(2, '0');
                    var yyyy = date1. getFullYear();
                    date1 = dd + '/' + mm + '/' + yyyy;
                    console.log(date1);
                    document.getElementById('d1_input').value = date1;
                };
            };
       }
    </script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['table']});
      google.charts.setOnLoadCallback(drawTable);
      var data_vehicles = {{ vehicles|safe }};

      function drawTable() {
        var data = new google.visualization.DataTable();

        data.addColumn('number', 'Modelo');
        data.addColumn('string', 'Placa');
        data.addColumn('string', 'Marca');
        data.addColumn('number', 'Odometro');


        for (var row in data_vehicles) {
            data.addRows([[
                          data_vehicles[row]['year'],
                          data_vehicles[row]['placa'],
                          data_vehicles[row]['marca'],
                          data_vehicles[row]['odometer']
            ]]);
        }

        var table = new google.visualization.Table(document.getElementById('table_div'));
        var options = {
            allowHtml: true,
            showRowNumber: true,
            width: '100%',
            cssClassNames: {
              tableCell: 'small-font'
            }
          };
        table.draw(data, options);

        //{showRowNumber: true, width: '100%', height: '2000%'}
          google.visualization.events.addListener(table, 'select', selectHandler);

               function selectHandler() {
                   console.log('holalala')
                    item = table.getSelection()[0]
                    if (item.row != null) {
                        console.log(data_vehicles[item.row]);

                        req2 = $.ajax({
                                url : "/update_vehicle/" + data_vehicles[item.row]['placa'],
                                type : "GET",
                            });

                        req2.done(function(res) {

                            if (res == 1) {
                                console.log('activo');
                            } else {
                                console.log('no_activo');
                                window.location.reload();
                            }
                        });

                    };
                };
      }


    </script>
    <div id="table_div" style="width: 96%; margin: 20px;"></div>
    <div class="variables">
        <form role="form" class="form-inline" action="{{ url_for('zones_interval') }}" method=post>

            <div style="width: 100%;margin: 10px;">
                <select class="form-control" id="CalendarVarSelect" name = calendar_var>
                    <option value="{{session.calendar_var}}"> {{session.calendar_pretty}}</option>
                    <option value="drivetime">Tiempo de manejo</option>
                    <option value="mec_power">Potencia efectiva (server) (kW) </option>
                    <option value="power_kw">Potencia eléctrica (Kw)</option>
                    <option value="elevation">Altitud (msnm)</option>
                    <option value="slope">Pendiente (°)</option>
                    <option value="speed">Velocidad (Km/h)</option>
                    <option value="mean_speed">Velocidad promedio (Km/h)</option>
                    <option value="odometer">Odometro (Km)</option>
                    <option value="capacity">Capacidad (kWh)</option>
                </select>
            </div>
            <div id="calendar_basic" style="width: 100%; height: 50%;margin: 20px;"></div>
            <div class='col-sm-2'>
                <label class="label label-default" for="date"> Fecha </label>
                <div class="form-group" id = 'date'>
                    <div class='input-group date' id='datetimepicker1'>
                        <input type='text' id = 'd1_input' class="form-control" name = 'd1' />
                        <span class="input-group-addon"><span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                document.getElementById('d1_input').defaultValue = '{{ session.form_d1 }}'
                $(function() {
                   $('#datetimepicker1').datetimepicker({
                         format: 'DD/MM/YYYY'
                   });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora1"> Desde </label>
                <div class="form-group" id="hora1">
                    <div class='input-group date' id='datetimepicker3'>
                        <input type='text' id = 'h1_input' class="form-control" name = 'h1'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script type="text/javascript">

                document.getElementById('h1_input').defaultValue = '{{ session.form_h1 }}'
                $(function () {
                    $('#datetimepicker3').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>

            <div class='col-sm-2'>
                <label class="label label-default" for="hora2"> Hasta </label>
                <div class="form-group" id="hora2">
                    <div class='input-group date' id='datetimepicker4'>
                        <input type='text' id = 'h2_input' class="form-control" name = 'h2'/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>
            </div>
            <script>
                document.getElementById('h2_input').defaultValue = '{{ session.form_h2 }}';
                $(function () {
                    $('#datetimepicker4').datetimepicker({
                        format: 'LT'
                    });
                });
            </script>


            <div class="col-auto">
                <button class="btn btn-dark" type="submit">Ver</button>
            </div>

            </form>
        </div>
    <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      overflow-y: scroll;
    }

    #deck-map-container {
      width: 96%;
      height: 90%;
      background-color: black;
    }

    #map {
      pointer-events: none;
      height: 96%;
      width: 90%;
      position: absolute;
      z-index: 1;
    }

    #deckgl-overlay {
      z-index: 2;
    }

    #deck-map-wrapper {
      width: 96%;
      height: 90%;
    }

    #deck-container {
      width: 96vw;
      height: 90vh;
    }
    </style>
  </head>
  <body>
    <div id="deck-container">
    </div>
  </body>
  <script>
    const jsonInput = {"initialViewState":{"bearing": -27.36, "latitude": 6.25184, "longitude": -75.56359, "maxZoom": 17, "minZoom": 3, "pitch": 40.5, "zoom": 11}, "layers":
    [{"@@type": "ScatterplotLayer", "data":{{json_zones}}, "filled": true, "getFillColor": [255, 140, 0], "getLineColor": [0, 0, 0], "getPosition": "@@=[longitude, latitude]", "id": "2695882c-7d5e-4f89-9e8a-049b84822d70", "lineWidthMinPixels": 1, "opacity": 0.8, "pickable": true, "radiusMaxPixels": 8, "radiusMinPixels": 8, "radiusScale": 6, "stroked": true},
    {"@@type": "LineLayer", "autoHighlight": true, "data": {{json_lines}}, "getSourcePosition": "@@=[longitude,latitude]", "getTargetPosition": "@@=[longitude2,latitude2]", "get_color": [0,240,0], "getWidth": 5, "highlightColor": [255, 255, 0], "id": "e7cf82d5-b4d6-4f9b-86ee-5f8712240607", "pickable": true, "pickingRadius": 10}],
     "mapStyle": "mapbox://styles/mapbox/outdoors-v11", "views": [{"@@type": "MapView", "controller": true}]};

    const MAPBOX_API_KEY = 'pk.eyJ1Ijoic2FudGlhZ28xNzFjYyIsImEiOiJja2NjZTkzOTkwM3ZxMndxa296YTVseGNkIn0.EFcvvL83cLQZYsqSgLVa6A';
    const tooltip = {'html':'<b>Zona : </b>{name}<b></b>', 'style': {'background': 'grey', 'color': 'white', 'font-family': '"Helvetica Neue", Arial', 'z-index': '10000'}};

    const deck = createDeck({
      mapboxApiKey: MAPBOX_API_KEY,
      container: document.getElementById('deck-container'),
      jsonInput,
      tooltip
    });
  </script>

</html>
{% endblock %}