{% extends "layout.html" %}
{% block body %}
{% if session.logged_in %}
    <style type="text/css">
        .divMap        {margin:0em auto;width:70vw; height:60vh; border: 1px solid #ccc; padding: 0em;
          display:block;float: center;background: white;}
        .container     {margin:0em auto;width:auto; height:auto;float: center; }
    </style>


    <body>
        <div id="line_top_x"></div>

        <div style="background-color:lightblue">
            <h3>Visualización Geográfica</h3>
        </div>


        <form action="{{ url_for('map_var') }}" method=post>
            <select name = variable>
                <option value="soc"> {{session.map_var}}</option>
                <option value="altitude">Altitud</option>
                <option value="powerKw">Potencia</option>
                <option value="soc">SOC</option>
                <option value="soh">SOH</option>
                <option value="batt_temp">Temperatura de batería</option>
                <option value="ext_temp">Temperatura externa</option>
                <option value="voltage">Voltage</option>
                <option value="batt_current">Corriente</option>
                <option value="engine_acceleration">Aceleración motor</option>
                <option value="throttle">% de aceleración</option>
                <option value="regenbrake">Freno regenerativo</option>
                <option value="consumption">Consumo</option>
                <option value="range_est">Rango estimado</option>
                <option value="range_ideal">Rango ideal</option>
                <option value="drivetime">Tiempo de manejo</option>
                <option value="footbrake">Freno de pedal</option>
                <option value="engine_temp">Temperatura de motor</option>
                <option value="is_charging">Está cargando</option>
            </select>

            <select name = Vehiculo>
                <option value="Seleccione vehiculo">{{session.map_car}}</option>
                <option value="Renault Twizy">Renault Twizy</option>
                <option value="Nissan Leaf">Nissan Leaf</option>
                <option value="Kia SOUL">Kia SOUL</option>
                <option value="BYD">BYD</option>
            </select>
            <dd><input type=submit value = Monitorear >
        </form>

        <!-- Map. -->

        <div class="divMap">

            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
            <script src="https://cdn.jsdelivr.net/npm/@deck.gl/jupyter-widget@^8.0.0/dist/index.js"></script>
            <style>
                body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                }

                #deck-map-container {
                width: 70vw;
                height: 60vh;
                background-color: black;
                float: left;
                }

                #map {
                pointer-events: none;
                width: 70vw;
                height: 60vh;
                position: absolute;
                z-index: 1;
                }

                #deckgl-overlay {
                z-index: 2;
                }

                #deck-map-wrapper {
                width: 100%;
                height: 100%;
                }

                #deck-container {
                width: 70vw;
                height: 60vh;
                float: left;
                }
            </style>

            <div id="deck-container"></div>
            <script>
                const jsonInput = {"initialViewState": {"bearing": -27.36, "latitude": 52.2323, "longitude": -1.415, "maxZoom": 15, "minZoom": 5, "pitch": 40.5, "zoom": 6}, "layers": [{"@@type": "HexagonLayer", "autoHighlight": true, "coverage": 1, "data": "https://raw.githubusercontent.com/uber-common/deck.gl-data/master/examples/3d-heatmap/heatmap-data.csv", "elevationRange": [0, 3000], "elevationScale": 50, "extruded": true, "getPosition": "@@=[lng, lat]", "id": "149bd184-76dd-45fe-9fdb-bc65e879bf51", "pickable": true}], "mapStyle": "mapbox://styles/mapbox/dark-v9", "views": [{"@@type": "MapView", "controller": true}]};
                const MAPBOX_API_KEY = 'pk.eyJ1Ijoic2VjaGF2YTQiLCJhIjoiY2s2dTF0eHQ0MDViaTNmbXRhaHVoaG85cSJ9.xMh2vZNuj2PfxsUksteApQ';
                const tooltip = true;

                const deck = createDeck({
                mapboxApiKey: MAPBOX_API_KEY,
                container: document.getElementById('deck-container'),
                jsonInput,
                tooltip
                });
            </script>
        </div>

        <div style="background-color:lightblue;margin: 1vh;padding: 1vh;overflow: hidden;">
            <h3>Visualización de datos</h3>
        </div>


        <!-- plotly graph. -->


        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <form action="{{ url_for('graph_var') }}" method=post>
            <select name = variable_x>
                <option value="tiempo"> {{session.graph_var_x}}</option>
                <option value="tiempo">Tiempo</option>
                <option value="altitude">Altitud</option>
                <option value="powerKw">Potencia</option>
                <option value="soc">SOC</option>
                <option value="soh">SOH</option>
                <option value="batt_temp">Temperatura de batería</option>
                <option value="ext_temp">Temperatura externa</option>
                <option value="voltage">Voltage</option>
                <option value="batt_current">Corriente</option>
                <option value="engine_acceleration">Aceleración motor</option>
                <option value="throttle">% de aceleración</option>
                <option value="regenbrake">Freno regenerativo</option>
                <option value="consumption">Consumo</option>
                <option value="range_est">Rango estimado</option>
                <option value="range_ideal">Rango ideal</option>
                <option value="drivetime">Tiempo de manejo</option>
                <option value="footbrake">Freno de pedal</option>
                <option value="engine_temp">Temperatura de motor</option>
            </select>

            <select name = variable_y>
                <option value="soc"> {{session.graph_var_y}}</option>
                <option value="altitude">Altitud</option>
                <option value="powerKw">Potencia</option>
                <option value="soc">SOC</option>
                <option value="soh">SOH</option>
                <option value="batt_temp">Temperatura de batería</option>
                <option value="ext_temp">Temperatura externa</option>
                <option value="voltage">Voltage</option>
                <option value="batt_current">Corriente</option>
                <option value="engine_acceleration">Aceleración motor</option>
                <option value="throttle">% de aceleración</option>
                <option value="regenbrake">Freno regenerativo</option>
                <option value="consumption">Consumo</option>
                <option value="range_est">Rango estimado</option>
                <option value="range_ideal">Rango ideal</option>
                <option value="drivetime">Tiempo de manejo</option>
                <option value="footbrake">Freno de pedal</option>
                <option value="engine_temp">Temperatura de motor</option>
                <option value="is_charging">Está cargando</option>
            </select>
            <dd><input type=submit value = "Ver histórico" >
        </form>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="chart" id="bargraph">
                        <script>
                            var graphs = {{plot | safe}};
                            Plotly.plot('bargraph',graphs,{});
                        </script>
                    </div>
                </div>
            </div>
        </div>

        <div style="background-color:lightblue;margin: 1vh;padding: 1vh;overflow: hidden;">
            <h3>Visualización de indicadores</h3>
        </div>

         <canvas data-type="radial-gauge"
            data-width="230"
            data-height="230"
            data-title="SOC"
            data-value = {{session.battery_temp}}
        ></canvas>

        <canvas data-type="radial-gauge"
            data-width="230"
            data-height="230"
            data-title="Voltaje"
            data-value = {{session.battery_temp}}
        ></canvas>




        <script src="/static/gauge.min.js"></script>
        <canvas data-type="radial-gauge"
            data-value="33.77"
            data-width="230"
            data-height="230"
            data-units="°C"
            data-title="°C Batería"
            data-min-value="0"
            data-max-value="60"
            data-major-ticks="[0,5,10, 15,20, 25, 30 ,35 ,40 , 45, 50, 55, 60]"
            data-minor-ticks="2"
            data-stroke-ticks="true"
            data-highlights='[ {"from": 0, "to": 25, "color": "rgba(0,0, 255, .3)"},
            {"from": 40, "to": 60, "color": "rgba(255, 0, 0, .3)"} ]'
            data-ticks-angle="225"
            data-start-angle="67.5"
            data-color-major-ticks="#ddd"
            data-color-minor-ticks="#ddd"
            data-color-title="#eee"
            data-color-units="#ccc"
            data-color-numbers="#eee"
            data-color-plate="#222"
            data-border-shadow-width="0"
            data-borders="true"
            data-needle-type="arrow"
            data-needle-width="2"
            data-needle-circle-size="7"
            data-needle-circle-outer="true"
            data-needle-circle-inner="false"
            data-animation-duration="1500"
            data-animation-rule="linear"
            data-color-border-outer="#333"
            data-color-border-outer-end="#111"
            data-color-border-middle="#222"
            data-color-border-middle-end="#111"
            data-color-border-inner="#111"
            data-color-border-inner-end="#333"
            data-color-needle-shadow-down="#333"
            data-color-needle-circle-outer="#333"
            data-color-needle-circle-outer-end="#111"
            data-color-needle-circle-inner="#111"
            data-color-needle-circle-inner-end="#222"
            data-value-box-border-radius="10"
            data-color-value-box-rect="#222"
            data-color-value-box-rect-end="#333"
        ></canvas>

        <canvas data-type="radial-gauge"
            data-title="Velocidad"
            data-value="96"
            data-width="230"
            data-height="230"
            data-units="km/h"
            data-min-value="0"
            data-max-value="220"
            data-major-ticks="0,20,40,60,80,100,120,140,160,180,200,220"
            data-minor-ticks="2"
            data-stroke-ticks="true"
            data-highlights='[
            {"from": 160, "to": 220, "color": "rgba(200, 50, 50, .75)"}
            ]'
            data-color-plate="#fff"
            data-border-shadow-width="0"
            data-borders="false"
            data-needle-type="arrow"
            data-needle-width="2"
            data-needle-circle-size="7"
            data-needle-circle-outer="true"
            data-needle-circle-inner="false"
            data-animation-duration="1500"
            data-animation-rule="linear"
        ></canvas>




        <canvas data-type="linear-gauge"
            data-width="120"
            data-height="300"
            data-units="%"
            data-title="SOH"
            data-min-value="0"
            data-max-value="100"
            data-major-ticks="0,10,20,30,40,50,60,70,80,90,100"
            data-minor-ticks="2"
            data-stroke-ticks="true"
            data-highlights='[ {"from": 0, "to": 70, "color": "rgba(200, 50, 50, .75)"} ]'
            data-color-plate="#fff"
            data-border-shadow-width="0"
            data-borders="false"
            data-needle-type="arrow"
            data-needle-width="2"
            data-animation-rule="linear"
            data-tick-side="left"
            data-number-side="left"
            data-needle-side="left"
            data-bar-stroke-width="7"
            data-bar-begin-circle="false"
            data-value={{session.battery_temp}}
        ></canvas>

        <canvas data-type="linear-gauge"
            data-width="120"
            data-height="300"
            data-units="°C"
            data-title="°C Motor"
            data-min-value="0"
            data-max-value="100"
            data-major-ticks="0,10,20,30,40,50,60,70,80,90,100"
            data-minor-ticks="2"
            data-stroke-ticks="true"
            data-highlights='[ {"from": 50, "to": 100, "color": "rgba(200, 50, 50, .75)"} ]'
            data-color-plate="#fff"
            data-border-shadow-width="0"
            data-borders="false"
            data-needle-type="arrow"
            data-needle-width="2"
            data-animation-duration="1500"
            data-animation-rule="linear"
            data-tick-side="left"
            data-number-side="left"
            data-needle-side="left"
            data-bar-stroke-width="7"
            data-bar-begin-circle="false"
            data-value={{session.battery_temp}}
        ></canvas>

    </body>
{% endif %}
{% endblock %}
